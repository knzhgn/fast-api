# FastAPI: Заметки с RBAC (CRUD с Привязкой к Пользователю)

REST API на **FastAPI** для управления заметками (`Note`) с учетом прав доступа: каждый пользователь может создавать, читать, обновлять и удалять только свои заметки. Реализована аутентификация через **JWT-токены**, а данные хранятся в **PostgreSQL** с использованием **SQLModel**.

## Описание

Проект демонстрирует реализацию API с контролем доступа на основе владельца ресурса (RBAC):

- Пользователи могут управлять только своими заметками.
- Аутентификация осуществляется через **JWT-токены**.
- Доступ к чужим заметкам ограничен (ошибка 404 при попытке доступа).
- Пароли хешируются с использованием **bcrypt**.

## Технологии

- **FastAPI**
- **PostgreSQL** (с использованием **asyncpg**)
- **SQLModel** / **SQLAlchemy** (ORM)
- **Passlib** (схема **bcrypt** для хеширования паролей)
- **python-jose** (для работы с JWT-токенами)
- **Uvicorn** (ASGI-сервер)

## Установка и запуск

1. **Клонирование репозитория**:  
   Клонируйте репозиторий и перейдите в папку проекта:
   ```bash
   git clone <адрес_репозитория>
   cd <папка_проекта>
   ```

2. **Создание и активация виртуального окружения**:  
   - Создайте окружение:
     ```bash
     python -m venv .venv
     ```
   - Активируйте окружение:
     - Для Linux/macOS:
       ```bash
       source .venv/bin/activate
       ```
     - Для Windows:
       ```bash
       .venv\Scripts\activate
       ```

3. **Установка зависимостей**:  
   Установите необходимые пакеты:
   ```bash
   pip install -r requirements.txt
   pip install bcrypt  # обязательно для passlib
   ```

4. **Настройка подключения к базе данных**:  
   В файле `main.py` обновите переменную `DATABASE_URL`, указав свои параметры:
   ```python
   DATABASE_URL = "postgresql+asyncpg://username:password@localhost:5432/notesdb"
   ```

5. **Запуск сервера**:  
   Запустите сервер:
   ```bash
   uvicorn main:app --reload
   ```

   После запуска документация API доступна по адресу:  
   - **Swagger UI**: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)  
   - **ReDoc**: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

## API Эндпоинты

### Регистрация пользователя
- **Метод**: POST
- **URL**: `/register`
- **Content-Type**: `application/json`
- **Тело запроса** (JSON):
  ```json
  {
    "username": "user1",
    "password": "pass123"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "username": "user1"
  }
  ```

### Логин и получение токена
- **Метод**: POST
- **URL**: `/login`
- **Content-Type**: `application/json`
- **Тело запроса** (JSON):
  ```json
  {
    "username": "user1",
    "password": "pass123"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "access_token": "<JWT-токен>",
    "token_type": "bearer"
  }
  ```

### Создание заметки
- **Метод**: POST
- **URL**: `/notes`
- **Заголовки**:
  ```
  Authorization: Bearer <JWT-токен>
  Content-Type: application/json
  ```
- **Тело запроса** (JSON):
  ```json
  {
    "text": "Текст заметки"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "text": "Текст заметки",
    "owner_id": 1
  }
  ```

### Получение всех своих заметок
- **Метод**: GET
- **URL**: `/notes`
- **Заголовки**:
  ```
  Authorization: Bearer <JWT-токен>
  ```
- **Ответ** (JSON):
  ```json
  [
    {
      "id": 1,
      "text": "Текст заметки",
      "owner_id": 1
    }
  ]
  ```

### Получение одной заметки
- **Метод**: GET
- **URL**: `/notes/{note_id}`
- **Заголовки**:
  ```
  Authorization: Bearer <JWT-токен>
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "text": "Текст заметки",
    "owner_id": 1
  }
  ```
- **Ошибки**: `404 Not Found` — если заметка не найдена или принадлежит другому пользователю.

### Обновление заметки
- **Метод**: PUT
- **URL**: `/notes/{note_id}`
- **Заголовки**:
  ```
  Authorization: Bearer <JWT-токен>
  Content-Type: application/json
  ```
- **Тело запроса** (JSON):
  ```json
  {
    "text": "Обновлённый текст"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "text": "Обновлённый текст",
    "owner_id": 1
  }
  ```
- **Ошибки**: `404 Not Found` — если заметка не найдена или принадлежит другому пользователю.

### Удаление заметки
- **Метод**: DELETE
- **URL**: `/notes/{note_id}`
- **Заголовки**:
  ```
  Authorization: Bearer <JWT-токен>
  ```
- **Ответ** (JSON):
  ```json
  {
    "message": "Note deleted successfully"
  }
  ```
- **Ошибки**: `404 Not Found` — если заметка не найдена или принадлежит другому пользователю.

## Важные моменты

- **Ограничение доступа**: Пользователи могут управлять только своими заметками.
- **Безопасность паролей**: Пароли хешируются с использованием **bcrypt**.
- **JWT-аутентификация**: Все операции с заметками требуют валидный JWT-токен.
- **Автоматическое создание таблиц**: Таблицы создаются автоматически при первом запуске.
- **Тестирование**: Используйте **Swagger UI**, **ReDoc** или **Postman** для проверки эндпоинтов.

## Контакты

Если вам нужна помощь с проектом или есть вопросы, пишите мне в **Microsoft Teams**.