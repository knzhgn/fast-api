# FastAPI RBAC Project

Простой пример REST API на **FastAPI** с аутентификацией и контролем доступа на основе ролей (RBAC). Проект демонстрирует регистрацию пользователей, авторизацию через **JWT-токены** и ограничение доступа к эндпоинтам в зависимости от роли пользователя.

## Описание

- Пользователи регистрируются с ролью `user` по умолчанию.
- Администратор с ролью `admin` создаётся автоматически при запуске (логин: `admin`, пароль: `adminpass`).
- Авторизация осуществляется через **JWT-токены**.
- Эндпоинт `/admin/users` доступен только пользователям с ролью `admin`.
- Эндпоинт `/users/me` возвращает данные текущего пользователя.

## Технологии

- **FastAPI**
- **PostgreSQL** (с использованием **asyncpg**)
- **SQLModel** / **SQLAlchemy** (ORM)
- **Passlib** (схема **bcrypt** для хеширования паролей)
- **python-jose** (для работы с JWT-токенами)

## Установка и запуск

1. **Клонирование репозитория**:  
   Клонируйте репозиторий и перейдите в папку проекта:
   ```bash
   git clone <адрес_репозитория>
   cd <папка_проекта>
   ```

2. **Создание и активация виртуального окружения**:  
   - Создайте окружение:
     ```bash
     python -m venv .venv
     ```
   - Активируйте окружение:
     - Для Linux/macOS:
       ```bash
       source .venv/bin/activate
       ```
     - Для Windows:
       ```bash
       .venv\Scripts\activate
       ```

3. **Установка зависимостей**:  
   Установите необходимые пакеты:
   ```bash
   pip install -r requirements.txt
   pip install bcrypt  # обязательно для passlib
   ```

4. **Настройка подключения к базе данных**:  
   В файле `main.py` обновите строку `DATABASE_URL`, указав свои параметры:
   ```python
   DATABASE_URL = "postgresql+asyncpg://username:password@localhost:5432/notesdb"
   ```

5. **Запуск сервера**:  
   Запустите сервер:
   ```bash
   uvicorn main:app --reload
   ```

   После запуска документация API доступна по адресу:  
   - **Swagger UI**: [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)  
   - **ReDoc**: [http://127.0.0.1:8000/redoc](http://127.0.0.1:8000/redoc)

## Использование

### Регистрация пользователя (роль `user` по умолчанию)
- **Метод**: POST
- **URL**: `/register`
- **Content-Type**: `application/json`
- **Тело запроса** (JSON):
  ```json
  {
    "username": "user1",
    "password": "user1pass"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "username": "user1",
    "role": "user"
  }
  ```

### Вход в систему (логин)
- **Метод**: POST
- **URL**: `/login`
- **Content-Type**: `application/json`
- **Тело запроса** (JSON):
  ```json
  {
    "username": "user1",
    "password": "user1pass"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "access_token": "<токен>",
    "token_type": "bearer"
  }
  ```

### Получение данных текущего пользователя
- **Метод**: GET
- **URL**: `/users/me`
- **Требуемый заголовок**:
  ```
  Authorization: Bearer <токен>
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "username": "user1",
    "role": "user"
  }
  ```

### Эндпоинт для администратора — список всех пользователей
- **Метод**: GET
- **URL**: `/admin/users`
- **Требуемый заголовок**:
  ```
  Authorization: Bearer <токен администратора>
  ```
- **Доступ**: Только для пользователей с ролью `admin`.
- **Ответ** (JSON):
  ```json
  [
    {
      "id": 1,
      "username": "admin",
      "role": "admin"
    },
    {
      "id": 2,
      "username": "user1",
      "role": "user"
    }
  ]
  ```

## Создание администратора

При первом запуске автоматически создаётся пользователь-администратор:  
- **Логин**: `admin`  
- **Пароль**: `adminpass`  
- **Роль**: ` Alfredo`

## Примечания

- **Автоматическое создание таблиц**: Таблица пользователей создаётся автоматически при первом запуске.
- **Миграции**: Если в модель добавлены новые поля, используйте миграции (например, с **Alembic**) или удалите таблицу вручную для обновления структуры.
- **Хеширование паролей**: Для корректной работы хеширования паролей убедитесь, что установлен пакет `bcrypt`.
- **Тестирование**: Используйте **Swagger UI**, **ReDoc** или **Postman** для проверки эндпоинтов.

## Контакты

Если вам нужна помощь с проектом или есть вопросы, пишите мне в **Microsoft Teams**.