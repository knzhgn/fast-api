# FastAPI: Автоматизированное Тестирование API

Проект выполнен по техническому заданию №9. Реализован набор автоматических тестов для REST API управления пользователями и заметками с использованием **FastAPI**, **pytest**, **TestClient** и **SQLModel**. Тесты охватывают аутентификацию, защищённые эндпоинты и CRUD-операции заметок.

## Описание

Проект демонстрирует подход к автоматизированному тестированию REST API с акцентом на:

- **Тестовая среда**: Настройка изолированной тестовой базы данных и **TestClient** для HTTP-запросов.
- **Аутентификация**: Тестирование регистрации и логина с использованием **JWT-токенов**.
- **CRUD-операции**: Проверка создания, получения и удаления заметок, привязанных к пользователю.
- **Безопасность**: Проверка доступа только к собственным данным и обработка ошибок.

## Требования

Перед началом работы убедитесь, что установлены:

- **Python 3.11+**
- **PostgreSQL**

### Зависимости

Установите зависимости с помощью команды:
```bash
pip install -r requirements.txt
```

Список зависимостей:
- **`fastapi`**: Веб-фреймворк для создания API.
- **`uvicorn`**: ASGI-сервер для запуска приложения.
- **`sqlmodel`**: ORM для работы с базой данных.
- **`asyncpg`**: Асинхронный драйвер для PostgreSQL.
- **`passlib`**: Хеширование паролей (схема **bcrypt**).
- **`pyjwt`**: Создание и проверка **JWT-токенов**.
- **`pytest`**, **`pytest-asyncio`**, **`httpx`**: Инструменты для тестирования.

## Настройка тестовой базы данных

1. **Установка PostgreSQL**:  
   Установите PostgreSQL локально или используйте облачное решение, например, [ElephantSQL](https://www.elephantsql.com/).

2. **Создание тестовой базы данных**:  
   Создайте тестовую базу данных `test_notesdb`:
   ```sql
   CREATE DATABASE test_notesdb;
   ```

3. **Настройка подключения**:  
   В файле `database.py` обновите строку подключения для тестовой базы:
   ```python
   DATABASE_URL = "postgresql+asyncpg://username:password@localhost:5432/test_notesdb"
   ```

4. **Создание таблиц**:  
   Таблицы `users` и `notes` создаются автоматически через фикстуру pytest. Для ручного создания:
   ```python
   from database import create_db_and_tables
   create_db_and_tables()
   ```

## Запуск приложения и тестов

1. **Запуск сервера (для ручного тестирования)**:
   ```bash
   uvicorn main:app --reload
   ```
   - Сервер доступен по адресу: [http://127.0.0.1:8000](http://127.0.0.1:8000).

2. **Запуск тестов**:
   ```bash
   pytest test_main.py
   ```

## Эндпоинты API и тесты

### 1. **POST `/register`**
- **Описание**: Регистрация нового пользователя.
- **Тело запроса** (JSON):
  ```json
  {
    "username": "testuser",
    "password": "testpass123"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "id": 1,
    "username": "testuser"
  }
  ```
- **Тесты**:
  - Успешная регистрация нового пользователя.
  - Ошибка при попытке повторной регистрации (400 Bad Request).

### 2. **POST `/login`**
- **Описание**: Аутентификация и получение **JWT-токена**.
- **Тело запроса** (JSON):
  ```json
  {
    "username": "testuser",
    "password": "testpass123"
  }
  ```
- **Ответ** (JSON):
  ```json
  {
    "access_token": "jwt_token_here",
    "token_type": "bearer"
  }
  ```
- **Тесты**:
  - Успешное получение токена.
  - Ошибка при неверных данных (401 Unauthorized).

### 3. **GET `/notes`**
- **Описание**: Получение списка заметок пользователя с пагинацией и фильтрацией.
- **Параметры запроса**:
  - `skip` (опционально): Количество пропускаемых записей (по умолчанию 0).
  - `limit` (опционально): Ограничение количества записей.
  - `search` (опционально): Фильтрация по содержимому заметок.
- **Пример запроса**:
  ```http
  GET /notes?skip=0&limit=10&search=test
  ```
- **Ответ** (JSON):
  ```json
  [
    {
      "id": 1,
      "text": "Test note",
      "created_at": "2025-06-05T15:04:00+05:00",
      "owner_id": 1
    }
  ]
  ```
- **Тесты**:
  - Получение только своих заметок.
  - Ошибка при отсутствии токена (401 Unauthorized).

## Тестирование через Postman

1. **Запуск сервера**:
   ```bash
   uvicorn main:app --reload
   ```

2. **Тестирование эндпоинтов**:
   - **POST `/register`**: Создание пользователя.
     - **URL**: `http://127.0.0.1:8000/register`
   - **POST `/login`**: Получение токена.
     - **URL**: `http://127.0.0.1:8000/login`
   - **GET `/notes`**: Получение заметок.
     - **URL**: `http://127.0.0.1:8000/notes?skip=0&limit=10`
     - **Заголовок**: `Authorization: Bearer <JWT-токен>`

3. **Проверка аутентификации**:
   - Добавьте заголовок:
     - **Key**: `Authorization`
     - **Value**: `Bearer <your_token>`

## Примечания

- **Безопасность**: Пароли хешируются с использованием **bcrypt**, доступ ограничен владельцем заметки.
- **Тестовая база данных**: Используется изолированная база `test_notesdb` для предотвращения влияния на основную базу.
- **Документация**: Доступна через **Swagger UI** по адресу `/docs`.

## Контакты

По вопросам и предложениям пишите в **Microsoft Teams**.